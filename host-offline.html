<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cli‑Mit Quest Offline</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Cli‑Mit Quest</h1>
    <p>Offline Host Screen</p>
  </header>
  <main>
    <section id="scoreboard"></section>
    <section id="board"></section>

    <!-- Instructions shown after game starts -->
    <section id="instructions" style="display:none; max-width: 900px; margin-top:1rem;" aria-live="polite">
      <h2>How to Play with Colour Buzzers</h2>
      <p>
        Each team has a colour. When a question is asked, the first team to hold
        up their coloured card or flag gets to answer. The host clicks the
        corresponding colour button in the modal to register which team buzzed
        in. Only when the answer is judged correct will the question tile
        disappear and points be awarded.
      </p>
      <p>
        Need cards? Print the <a href="buzzers.html" target="_blank">colour buzzer cards</a>
        (one per team) before hosting. They include a large coloured bar with
        the team name for easy visibility.
      </p>
    </section>
  </main>

  <!-- Setup Modal: multi-step wizard for teams and buzzers -->
  <div id="setup-modal" class="setup-overlay">
    <div class="setup-content">
      <!-- Step 1: Teams -->
      <div id="team-step">
        <h2>Game Setup</h2>
        <p>Select the number of teams and enter their names.</p>
        <label for="team-count">Number of teams:</label>
        <select id="team-count">
          <option value="2">2 Teams</option>
          <option value="3">3 Teams</option>
          <option value="4">4 Teams</option>
        </select>
        <div id="team-names"></div>
        <button id="to-phone-step" class="primary">Next: Buzzers</button>
      </div>
      <!-- Step 2: Buzzers and join list -->
      <div id="phone-step" style="display:none;">
        <h2>Phone Buzzers</h2>
        <p>
          Let your teams buzz with their phones. Click the button below to create a room code and display a join link and QR. Share these with players so they can join via their phones. A live list of joined players will appear below.
        </p>
        <button id="create-room-btn" class="primary">Enable Phone Buzzers</button>
        <div id="phone-room-info" style="display:none; margin-top:0.75rem;">
          <p><strong>Room code:</strong> <span id="phone-room-code">—</span></p>
          <!-- Real QR image will be inserted by phones.js -->
          <img id="phone-qr" width="180" height="180" alt="Room QR code" />
          <p><strong>Join URL:</strong> <span id="join-url"></span></p>
        </div>
        <!-- Joined players list -->
        <div id="player-list" style="display:none; margin-top:0.75rem;">
          <h3>Joined players</h3>
          <ul id="players-ul"></ul>
        </div>
        <!-- Backup colour cards: optional fallback -->
        <div class="buzzer-info" style="margin-top:1rem;">
          <h3>Backup Colour Cards</h3>
          <p>
            As a fallback, each team can have a coloured card matching their team colour. The first team to raise their card gets to answer. Below are small previews of the coloured BUZZ cards.
          </p>
          <div class="buzzer-preview-container">
            <div class="buzzer-preview green">BUZZ</div>
            <div class="buzzer-preview blue">BUZZ</div>
            <div class="buzzer-preview yellow">BUZZ</div>
            <div class="buzzer-preview red">BUZZ</div>
          </div>
          <p>
            You can print full‑size coloured “BUZZ” cards for each team before hosting. These cards are larger postcard‑sized versions of the previews shown above.
            <a href="buzzers.html" target="_blank">Open printable buzzer cards</a>
          </p>
        </div>
        <button id="start-game-btn" class="primary" style="margin-top:1rem;">Start Game</button>
      </div>
    </div>
  </div>
  <div id="modal" class="hidden">
    <div class="modal-content">
      <h2 id="modal-category"></h2>
      <p id="modal-question"></p>
      <!-- Answer block: use inline display none so JS can toggle it -->
      <div id="answer-block" style="display:none;">
        <p id="modal-answer"></p>
      </div>
      <div class="modal-actions">
        <!-- Team buttons row -->
        <div id="team-select"></div>
        <!-- Control buttons row -->
        <div class="control-buttons">
          <button id="show-answer">Show Answer</button>
          <button id="correct-btn" class="success">Correct</button>
          <button id="wrong-btn" class="fail">Wrong</button>
          <button id="burnout-btn" class="burnout">Burnout</button>
          <button id="close-btn">Close</button>
        </div>
      </div>
    </div>
  </div>
  <script src="app.js"></script>
  <!-- Firebase SDKs for phone buzzer functionality -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- Include auth so anonymous sign‑in works if rules require it -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <!-- Placeholder QR renderer -->
  <script src="assets/qr-min.js"></script>
  <!-- Host-side phone integration -->
  <script src="phones.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Handler for Next button: move from team selection to phone step
      const nextBtn = document.getElementById('to-phone-step');
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          const teamStep = document.getElementById('team-step');
          const phoneStep = document.getElementById('phone-step');
          if (teamStep) teamStep.style.display = 'none';
          if (phoneStep) phoneStep.style.display = 'block';
        });
      }
      // Handler for enabling phone buzzers
      const btn = document.getElementById('create-room-btn');
      if (btn) {
        btn.addEventListener('click', async () => {
          // Always gather the current team names and colours before creating
          {
            const countSel = document.getElementById('team-count');
            const count = countSel ? parseInt(countSel.value) : 0;
            window.teams = [];
            const defaultColours = ['#2d6a4f', '#386fa4', '#e9c46a', '#e76f51'];
            const defaultNames   = ['Green', 'Blue', 'Yellow', 'Red'];
            for (let i = 0; i < count; i++) {
              const input = document.getElementById(`team-name-${i}`);
              const name = input && input.value ? input.value.trim() : '';
              const colour = defaultColours[i] || '#386fa4';
              const teamName = name || defaultNames[i] || `Team ${i + 1}`;
              window.teams.push({ name: teamName, color: colour, score: 0 });
            }
          }
          if (window.phones && typeof window.phones.createRoom === 'function') {
            await window.phones.createRoom();
            // Subscribe to player list updates to show joined users
            if (typeof window.phones.onPlayerListUpdate === 'function') {
              window.phones.onPlayerListUpdate((players) => {
                const listDiv = document.getElementById('player-list');
                const ul = document.getElementById('players-ul');
                if (!listDiv || !ul) return;
                listDiv.style.display = 'block';
                ul.innerHTML = '';
                Object.values(players).forEach((p) => {
                  const li = document.createElement('li');
                  const teamIdx = typeof p.team === 'number' ? p.team : 0;
                  let teamName = '';
                  if (window.teams && window.teams[teamIdx]) {
                    teamName = window.teams[teamIdx].name;
                  }
                  li.textContent = p.name;
                  li.style.backgroundColor = window.teams && window.teams[teamIdx] ? window.teams[teamIdx].color : '#386fa4';
                  li.style.color = '#fff';
                  li.style.padding = '2px 6px';
                  li.style.borderRadius = '4px';
                  li.style.fontSize = '0.8rem';
                  li.style.whiteSpace = 'nowrap';
                  ul.appendChild(li);
                });
              });
            }
          }
        });
      }
      // Start the game from step 2
      const startBtn = document.getElementById('start-game-btn');
      if (startBtn) {
        startBtn.addEventListener('click', () => {
          const countSel = document.getElementById('team-count');
          const count = countSel ? parseInt(countSel.value) : 0;
          teams = [];
          for (let i = 0; i < count; i++) {
            const input = document.getElementById(`team-name-${i}`);
            const name = input && input.value ? input.value.trim() : COLOUR_OPTIONS[i].defaultName;
            const { color } = COLOUR_OPTIONS[i];
            teams.push({ name, color, score: 0 });
          }
          window.teams = teams;
          buildScoreboard();
          buildBoard();
          const overlay = document.getElementById('setup-modal');
          if (overlay) overlay.style.display = 'none';
          const instructions = document.getElementById('instructions');
          if (instructions) instructions.style.display = 'block';
        });
      }
    });
  </script>
</body>
</html>